<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Admin - Estudiantes</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/admin.css">
</head>

<body class="bg-light">
    <script>
        // Verificar login antes de mostrar admin
        if (localStorage.getItem("loggedIn") !== "true") {
            window.location.href = "login.html";
        }
    </script>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <a class="navbar-brand brand-link" href="index.html">Gesti√≥n Estudiantes</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">Inicio</a>
                </li>
                <li class="nav-item d-none" id="btnLogoutNav">
                    <a class="nav-link text-danger" href="#" onclick="logout()">Salir</a>
                </li>
            </ul>
        </div>
    </nav>
    <div class="container mt-4">
        <div class="row mb-3">
            <div class="col-md-6">
                <h2 class="mb-0 text-primary-color">Administraci√≥n de Estudiantes</h2>
            </div>
            <div class="col-md-6 d-flex align-items-center justify-content-md-end mt-2 mt-md-0">
                <select id="filtroDocente" class="form-control mr-2 max-w-200" style="max-width: 200px;">
                    <option value="">Todos los docentes</option>
                </select>
                <input id="searchInput" type="text" class="form-control max-w-300"
                    placeholder="Buscar por nombre o c√≥digo...">
            </div>
        </div>
        <div class="d-flex mb-3">
            <button class="btn btn-primary mr-2" data-toggle="modal" data-target="#modalAgregar">
                ‚ûï Agregar Estudiante
            </button>
            <button id="btnEditarMasivo" class="btn btn-info" disabled>
                ‚úèÔ∏è Edici√≥n Masiva (<span id="contadorSeleccionados">0</span>)
            </button>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead class="thead-dark">
                    <tr>
                        <th>
                            <input type="checkbox" id="seleccionarTodos" title="Seleccionar todos">
                        </th>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>C√≥digo</th>
                        <th>Docente</th>
                        <th>Encargado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaEstudiantes">
                    <!-- Los estudiantes se cargar√°n aqu√≠ con JS -->
                </tbody>
            </table>
        </div>
    </div>
    <!-- Modal Agregar -->
    <div class="modal fade" id="modalAgregar" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="formAgregar">
                    <div class="modal-header">
                        <h5 class="modal-title">Agregar Estudiante</h5>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <input type="text" class="form-control mb-2" name="nombre" placeholder="Nombre" required>
                        <input type="text" class="form-control mb-2" name="codigo" placeholder="C√≥digo" required>
                        <input type="text" class="form-control mb-2" name="docente" placeholder="Docente">
                        <input type="text" class="form-control mb-2" name="encargado" placeholder="Encargado">
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Guardar</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Modal Editar -->
    <div class="modal fade" id="modalEditar" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="formEditar">
                    <div class="modal-header">
                        <h5 class="modal-title">Editar Estudiante</h5>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="id">
                        <input type="text" class="form-control mb-2" name="nombre" placeholder="Nombre" required>
                        <input type="text" class="form-control mb-2" name="codigo" placeholder="C√≥digo" required>
                        <input type="text" class="form-control mb-2" name="docente" placeholder="Docente">
                        <input type="text" class="form-control mb-2" name="encargado" placeholder="Encargado">
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Actualizar</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Modal Edici√≥n Masiva -->
    <div class="modal fade" id="modalEditarMasivo" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="formEditarMasivo">
                    <div class="modal-header">
                        <h5 class="modal-title">Edici√≥n Masiva</h5>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Campo a editar:</label>
                            <select class="form-control mb-3" id="campoEditar">
                                <option value="docente">Docente</option>
                                <option value="encargado">Encargado</option>
                            </select>
                        </div>
                        <div id="docenteFields" class="form-group">
                            <label>Docente actual:</label>
                            <select class="form-control mb-3" id="docenteActual">
                                <option value="">Seleccionar docente...</option>
                            </select>
                            <label>Nuevo docente:</label>
                            <input type="text" class="form-control" id="nuevoDocente" placeholder="Nuevo docente">
                            <button type="button" class="btn btn-info btn-sm mt-2" id="btnSeleccionarPorDocente">
                                Seleccionar estudiantes de este docente
                            </button>
                        </div>
                        <div id="otrosCampos" class="form-group d-none">
                            <label>Nuevo valor:</label>
                            <input type="text" class="form-control" id="nuevoValor">
                        </div>
                        <small class="text-muted">Se actualizar√°n <span id="cantidadEstudiantes">0</span> estudiantes
                            seleccionados.</small>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Actualizar</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Footer -->
    <footer class="footer mt-auto">
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-3 mb-md-0">
                    <h5 class="text-uppercase">Gesti√≥n Estudiantes</h5>
                    <p class="mb-1">Sistema profesional para la gesti√≥n y control de listas de salida de estudiantes.
                    </p>
                </div>
                <div class="col-md-4 mb-3 mb-md-0">
                    <h6 class="text-uppercase">Enlaces √∫tiles</h6>
                    <ul class="list-unstyled">
                        <li><a href="index.html">Inicio</a></li>
                        <li><a href="admin.html">Admin</a></li>
                        <li><a href="#" onclick="window.scrollTo(0,0)">Ir arriba</a></li>
                    </ul>
                </div>
                <div class="col-md-4 text-md-right">
                    <h6 class="text-uppercase">Contacto</h6>
                    <p class="mb-1">Desarrollado por <a
                            href="https://www.instagram.com/yeison02._.ssj?igsh=cTBqc2I4YXpwbXFj" target="_blank">Yeison
                            Prada</a></p>
                    <p class="mb-0">&copy; <span id="year"></span> Todos los derechos reservados.</p>
                </div>
            </div>
        </div>
    </footer>
    <div class="theme-toggle">
        <button id="toggleTheme" class="btn btn-outline-secondary" title="Cambiar tema">
            <span id="themeIcon" class="fas fa-moon"></span>
        </button>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script>
        // Modo oscuro
        const toggleThemeBtn = document.getElementById('toggleTheme');
        const themeIcon = document.getElementById('themeIcon');
        function setTheme(dark) {
            if (dark) {
                document.body.classList.add('theme-dark');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
                toggleThemeBtn.setAttribute('title', 'Modo claro');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('theme-dark');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
                toggleThemeBtn.setAttribute('title', 'Modo oscuro');
                localStorage.setItem('theme', 'light');
            }
        }
        toggleThemeBtn.addEventListener('click', function () {
            const isDark = document.body.classList.contains('theme-dark');
            setTheme(!isDark);
        });
        if (localStorage.getItem('theme') === 'dark') {
            setTheme(true);
        }
        document.getElementById('year').textContent = new Date().getFullYear();

        let estudiantesGlobal = [];
        let docentesUnicos = new Set();

        async function cargarEstudiantes() {
            const res = await fetch("/api/estudiantes");
            const estudiantes = await res.json();
            estudiantesGlobal = estudiantes;
            renderTabla(estudiantes);
            actualizarListaDocentes();
        }
        let estudiantesSeleccionados = new Set();
        function renderTabla(estudiantes) {
            const tbody = document.getElementById("tablaEstudiantes");
            tbody.innerHTML = "";
            estudiantes.forEach(est => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>
                        <input type="checkbox" class="seleccion-estudiante" data-id="${est.id}" 
                            ${estudiantesSeleccionados.has(est.id) ? 'checked' : ''}>
                    </td>
                    <td>${est.id}</td>
                    <td>${est.nombre}</td>
                    <td>${est.codigo}</td>
                    <td>${est.docente || ""}</td>
                    <td>${est.encargado || ""}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick='abrirEditar(${JSON.stringify(est)})'>‚úèÔ∏è Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="eliminar(${est.id})">üóëÔ∏è Eliminar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            actualizarContadorSeleccionados();
        }
        document.getElementById("searchInput").addEventListener("input", function () {
            const value = this.value.trim().toLowerCase();
            const filtrados = estudiantesGlobal.filter(est =>
                est.nombre.toLowerCase().includes(value) ||
                est.codigo.toLowerCase().includes(value)
            );
            renderTabla(filtrados);
        });

        function abrirEditar(est) {
            const form = document.getElementById("formEditar");
            form.id.value = est.id;
            form.nombre.value = est.nombre;
            form.codigo.value = est.codigo;
            form.docente.value = est.docente || "";
            form.encargado.value = est.encargado || "";
            $("#modalEditar").modal("show");
        }

        document.getElementById("formAgregar").addEventListener("submit", async (e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target).entries());
            await fetch("/api/estudiantes", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            $("#modalAgregar").modal("hide");
            e.target.reset();
            cargarEstudiantes();
        });

        document.getElementById("formEditar").addEventListener("submit", async (e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target).entries());
            await fetch(`/api/estudiantes/${data.id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            $("#modalEditar").modal("hide");
            cargarEstudiantes();
        });

        // Manejo de selecci√≥n
        document.addEventListener('click', function (e) {
            if (e.target.matches('#seleccionarTodos')) {
                const checkboxes = document.querySelectorAll('.seleccion-estudiante');
                checkboxes.forEach(cb => {
                    cb.checked = e.target.checked;
                    const id = parseInt(cb.dataset.id);
                    if (e.target.checked) {
                        estudiantesSeleccionados.add(id);
                    } else {
                        estudiantesSeleccionados.delete(id);
                    }
                });
                actualizarContadorSeleccionados();
            }

            if (e.target.matches('.seleccion-estudiante')) {
                const id = parseInt(e.target.dataset.id);
                if (e.target.checked) {
                    estudiantesSeleccionados.add(id);
                } else {
                    estudiantesSeleccionados.delete(id);
                }
                actualizarContadorSeleccionados();
            }
        });

        function actualizarContadorSeleccionados() {
            const contador = estudiantesSeleccionados.size;
            document.getElementById('contadorSeleccionados').textContent = contador;
            document.getElementById('cantidadEstudiantes').textContent = contador;
            document.getElementById('btnEditarMasivo').disabled = contador === 0;
        }

        // Edici√≥n masiva
        document.getElementById('btnEditarMasivo').addEventListener('click', function () {
            $('#modalEditarMasivo').modal('show');
        });

        function actualizarListaDocentes() {
            docentesUnicos = new Set(estudiantesGlobal
                .map(est => est.docente)
                .filter(docente => docente && docente.trim() !== ''));

            const filtroDocente = document.getElementById('filtroDocente');
            const docenteActual = document.getElementById('docenteActual');

            // Limpiar y agregar opci√≥n por defecto
            filtroDocente.innerHTML = '<option value="">Todos los docentes</option>';
            docenteActual.innerHTML = '<option value="">Seleccionar docente...</option>';

            // Agregar docentes a ambos selectores
            docentesUnicos.forEach(docente => {
                filtroDocente.add(new Option(docente, docente));
                docenteActual.add(new Option(docente, docente));
            });
        }

        document.getElementById('filtroDocente').addEventListener('change', function () {
            const docenteSeleccionado = this.value;
            const filtrados = docenteSeleccionado
                ? estudiantesGlobal.filter(est => est.docente === docenteSeleccionado)
                : estudiantesGlobal;
            renderTabla(filtrados);
        });

        document.getElementById('campoEditar').addEventListener('change', function () {
            const isDocente = this.value === 'docente';
            document.getElementById('docenteFields').classList.toggle('d-none', !isDocente);
            document.getElementById('otrosCampos').classList.toggle('d-none', isDocente);
        });

        document.getElementById('btnSeleccionarPorDocente').addEventListener('click', function () {
            const docenteSeleccionado = document.getElementById('docenteActual').value;
            if (!docenteSeleccionado) {
                alert('Por favor seleccione un docente');
                return;
            }

            estudiantesSeleccionados.clear();
            const estudiantesDelDocente = estudiantesGlobal.filter(est => est.docente === docenteSeleccionado);
            estudiantesDelDocente.forEach(est => estudiantesSeleccionados.add(est.id));
            actualizarContadorSeleccionados();
            renderTabla(estudiantesGlobal);
        });

        document.getElementById('formEditarMasivo').addEventListener('submit', async function (e) {
            e.preventDefault();
            const campo = document.getElementById('campoEditar').value;
            const valor = campo === 'docente'
                ? document.getElementById('nuevoDocente').value
                : document.getElementById('nuevoValor').value;

            if (!valor) {
                alert('Por favor ingrese un valor');
                return;
            }

            try {
                const token = localStorage.getItem('loggedIn');
                if (!token) {
                    alert('Sesi√≥n expirada. Por favor, vuelva a iniciar sesi√≥n.');
                    window.location.href = 'login.html';
                    return;
                }

                const estudiantes = Array.from(estudiantesSeleccionados);
                let errores = [];

                for (const id of estudiantes) {
                    try {
                        // Primero obtenemos el estudiante actual
                        const estudianteActual = estudiantesGlobal.find(e => e.id === id);
                        if (!estudianteActual) {
                            throw new Error('Estudiante no encontrado');
                        }

                        // Creamos un objeto con todos los datos actuales
                        const datosActualizados = {
                            nombre: estudianteActual.nombre,
                            codigo: estudianteActual.codigo,
                            docente: estudianteActual.docente,
                            encargado: estudianteActual.encargado,
                            // Actualizamos solo el campo espec√≠fico
                            [campo]: valor
                        };

                        const response = await fetch(`/api/estudiantes/${id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(datosActualizados)
                        });

                        if (!response.ok) {
                            throw new Error(`Error al actualizar estudiante ${id}: ${response.statusText}`);
                        }

                        const responseData = await response.json();
                        if (!responseData.success) {
                            throw new Error(responseData.message || 'Error al actualizar');
                        }
                    } catch (err) {
                        errores.push(`ID ${id}: ${err.message}`);
                        console.error(`Error actualizando estudiante ${id}:`, err);
                    }
                }

                if (errores.length > 0) {
                    alert(`Se encontraron algunos errores:\n${errores.join('\n')}`);
                } else {
                    $('#modalEditarMasivo').modal('hide');
                    estudiantesSeleccionados.clear();
                    actualizarContadorSeleccionados();
                    await cargarEstudiantes();
                    actualizarListaDocentes();
                    alert('Estudiantes actualizados correctamente');
                }
            } catch (error) {
                alert('Error al realizar las actualizaciones');
                console.error('Error general:', error);
            }
        });

        async function eliminar(id) {
            if (!confirm("¬øSeguro que quieres eliminar este estudiante?")) return;
            await fetch(`/api/estudiantes/${id}`, { method: "DELETE" });
            cargarEstudiantes();
        }

        cargarEstudiantes();
    </script>
</body>

</html>